<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Depurando desde el templo con herramientas Zen en Python</title>
<meta name="description" content="En el ciclo de desarrollo que seguimos para construir la aplicación de nuestros sueños, nos encontramos situaciones en las que tenemos que recurrir a la ardu...">

<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://localhost:4000/blog/2019/depurando-herramientas-zen/">
<link rel="alternate" type="application/rss+xml" title="José Miguel López" href="http://localhost:4000/feed.xml" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-129308889-1', 'auto');
  ga('send', 'pageview');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/"><span></span> <small></small></a></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-rss"></i></a></li>
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Depurando desde el templo con herramientas Zen en Python</h1>
      <em class="post-meta">
        <time>Aug 2, 2019</time>
      </em>
    </header>

    <div class="post-content">
      <p>En el ciclo de desarrollo que seguimos para construir la aplicación de nuestros sueños, nos encontramos situaciones en las que tenemos que recurrir a la ardua labor de la depuración. Cuando el comportamiento de un componente software comienza a desafiar la lógica seguida en su implementación o cuando se llegan a dar casos límites que en un principio eran imposibles.</p>

<p>En esos momentos es hora de sacar un “nespresso” de la máquina, respirar profundamente e introducirse de lleno en los flujos del programa, con la pericia del mejor detective debemos identificar la parte del código que no se comporta como es debido.</p>

<p>Ya vemos que el trabajo puede tener cierta dificultad y debemos andarnos con cautela para no confundirnos de malhechor e incluso comprometer flujos que funcionan correctamente.</p>

<p>Es por ello que debemos contar con nuestro mejor arsenal de herramientas propias para Python.</p>

<h2 id="depurador-pdb">Depurador Pdb</h2>

<p>Herramienta interna de Python, que permite ejecutar código de forma interactiva, definiendo puntos de parada “breakpoint”, ejecutando paso a paso y permitiendo observar como se va comportando la aplicación.</p>

<p>No me extiendo en este punto dado que se explica muy bien en la <a href="https://docs.python.org/2/library/pdb.html">documentación oficial</a>.</p>

<p>En versiones de Python anteriores a 3.7 para activar la depuración pdb necesitábamos escribir</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></code></pre></figure>

<p>Con versiones Python 3.7+, no necesitamos realizar ninguna importación y tenemos las función “built-in” 
<code>breakpoint()</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">breakpoint</span><span class="p">()</span></code></pre></figure>

<h2 id="depurar-código-python-en-remoto">Depurar código Python en remoto.</h2>

<p>Otra de las opciones que tenemos en Python es depurar una rutina que se ejecuta en una máquina diferente al propio host donde nos encontramos trabajando, ya sea por ejemplo un servidor de integración, preproducción o un host virtualizado ya sea mediante un hipervisor o contenedor Docker.</p>

<p>Para este caso contamos con <a href="https://github.com/ionelmc/python-remote-pdb">remote-pdb</a>, que básicamente tiene el mismo comportamiento que pdb, pero exponiendo un sockets TCP para la comunicación de comando y respuestas.</p>

<p>Para iniciar remote-pdb debemos instalar el paquete “remote-pdb” y ejecutar las siguientes instrucciones:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">remote</span><span class="o">-</span><span class="n">pdb</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">remote_pdb</span> <span class="kn">import</span> <span class="n">RemotePdb</span>
<span class="n">RemotePdb</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">4444</span><span class="p">)</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></code></pre></figure>

<p>y para acceder a la consola <strong>Pdb</strong>, asegurándonos que tenemos visibilidad a la IP <strong>PYTHON_HOST_IP</strong>, ejecutar:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">telnet</span> <span class="n">PYTHON_HOST_IP</span> <span class="mi">4444</span></code></pre></figure>

<h2 id="mejoras-que-añade-breakpoint-al-uso-de-pdb">Mejoras que añade breakpoint al uso de pdb.</h2>

<p>Como vemos el cambio que introduce <strong>breakpoint</strong> a simple vista no es impresionante, seguimos escribiendo una línea de código (quizá un poco más syntax sugar), pero aporta algunas mejoras sensibles.</p>

<p>Poder cambiar el modo de depuración, (local, remota, deshabilitada).</p>

<p>Estableciendo las variables de entorno <strong>PYTHONBREAKPOINT</strong> podemos establecer <code>pdb.set_trace</code> para depuración en local, <code>remote_pdb.set_trace</code> para depuración en remoto y <code>0</code> para deshabilitar depuración y que la instrucción <code>breakpoint()</code> sea transparente.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">PYTHONBREAKPOINT</span><span class="o">=</span><span class="n">remote_pdb</span><span class="o">.</span><span class="n">set_trace</span>
<span class="n">REMOTE_PDB_HOST</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> 
<span class="n">REMOTE_PDB_PORT</span><span class="o">=</span><span class="mi">4444</span></code></pre></figure>

<h2 id="depurando-en-contenedor-docker-de-forma-remota">Depurando en contenedor Docker de forma remota.</h2>

<p>Tenemos la siguiente aplicación python cuya finalidad es transformar números enteros en números romanos, corre en un contenedor Docker y no podemos entrar directamente a su consola interna mediante <code>docker exec -it</code>, por lo tanto necesitamos hacer uso de las herramientas de depuración remota.</p>

<p>Aquí el código de nuestra aplicación:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="k">def</span> <span class="nf">int2roman</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="n">breakpoint</span><span class="p">()</span>

    <span class="n">coding</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;CM&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;CD&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;XC&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;XL&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;IX&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;IV&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">4000</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">!=</span> <span class="n">number</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input should be an integer between 1 and 3999&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">integer</span><span class="p">,</span> <span class="n">roman</span> <span class="ow">in</span> <span class="n">coding</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="n">integer</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roman</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">-=</span> <span class="n">integer</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></figure>

<p>Aquí el script de test de la función:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">int2roman</span> <span class="kn">import</span> <span class="n">int2roman</span>

<span class="k">def</span> <span class="nf">test_int2roman_three_hundred_twenty_six</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">int2roman</span><span class="p">(</span><span class="mi">326</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;CCCXXVI&#39;</span>

<span class="n">test_int2roman_three_hundred_twenty_six</span><span class="p">()</span></code></pre></figure>

<p>La definición completa en Docker-Compose.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">python</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">python:3.7</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;4444:4444&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DOCKER=1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PYTHONBREAKPOINT=remote_pdb.set_trace</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REMOTE_PDB_HOST=0.0.0.0</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REMOTE_PDB_PORT=4444</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bash -c &quot;pip install remote-pdb &amp;&amp; python /code/test_int2roman.py&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">.:/code</span>
    <span class="l l-Scalar l-Scalar-Plain">stdin_open</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">tty</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span></code></pre></figure>

<p><img src="/images/terminal.gif" alt="terminal" /></p>

<h3 id="código-fuente-usado">Código fuente usado:</h3>
<ul>
  <li><a href="https://github.com/josemlp91/depurando_desde_el_tibet_con_herramientas_zen">https://github.com/josemlp91/depurando_desde_el_tibet_con_herramientas_zen</a></li>
</ul>

<h3 id="referencias">Referencias:</h3>
<ul>
  <li><a href="https://docs.python.org/2/library/pdb.html">https://docs.python.org/2/library/pdb.html</a></li>
  <li><a href="https://static.realpython.com/guides/pdb-command-reference.pdf">https://static.realpython.com/guides/pdb-command-reference.pdf</a></li>
  <li><a href="https://github.com/ionelmc/python-remote-pdb">https://github.com/ionelmc/python-remote-pdb</a></li>
</ul>


    </div>

    

  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://github.com/josemlp91" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="https://twitter.com/josemlp91" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://es.linkedin.com/in/josmilope" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2019 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥ by @josemlp</small>
    </p>
  </div>
</footer>


  <a href="https://github.com/josemlp91/josemlp91.github.io" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
</body>
</html>
